{"version":3,"file":null,"sources":["src/server/log.js","src/utils/guid.js","src/utils/shallow-equal.js","src/utils/changed.js","src/model/context-reducer.js","src/model/global-reducer.js","src/server/states/introduction.js","src/server/middleware/server-middleware.js","src/server/middleware/response-middleware.js","src/server/server-io.js","src/server/index.js"],"sourcesContent":["const winston = require('winston')\nconst path = require('path')\n\nconst logger = new (winston.Logger)({\n  transports: [\n    new (winston.transports.Console)(),\n    new (winston.transports.File)({ filename: path.join(__dirname, 'data/server.log')})\n  ]\n})\n\nexport default {\n  debug(...args){\n    logger.debug(...args)\n  },\n  info(...args){\n    logger.info(...args)\n  },\n  warn(...args){\n    logger.warn(...args)\n  },\n  error(...args){\n    logger.error(...args)\n  }\n}","function s4() {\n  return Math.floor((1 + Math.random()) * 0x10000)\n    .toString(16)\n    .substring(1);\n}\n\nexport default function guid() {\n\n  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +\n    s4() + '-' + s4() + s4() + s4()\n}\n","export default function shallowEqual(oldState, newState){\n  const resultOldToNew = Object.keys(oldState).reduce((result, oldKey) => {\n    return result === true ? result : oldState[oldKey] !== newState[oldKey]\n  }, false)\n\n  const resultNewToOld = Object.keys(newState).reduce((result, newKey) => {\n    return result === true ? result : oldState[newKey] !== newState[newKey]\n  }, false)\n\n  return !resultNewToOld && !resultOldToNew\n}","import shallowEqual from './shallow-equal'\n\nexport default function changed(oldState, newState){\n\n  return shallowEqual(oldState, newState) ? oldState : newState\n}","import {guid} from '../utils'\n\nconst initialState = {\n  actionState:[],\n  messages : [{\n    id : guid(),\n    from : 'Chat System',\n    to : 'all',\n    message : 'Welcome to chat'\n  }]\n}\n\nexport default function contextReducer(state = initialState, action){\n  switch(action.type){\n    case 'CLIENT_STATE_ENTER_PUSH': return {\n      ...state,\n      actionState: state.actionState.concat(action.name)\n    }\n    case 'CLIENT_STATE_ENTER_REPLACE' : return {\n      ...state,\n      actionState: state.actionState.slice(0,state.actionState.length-1).concat(action.name)\n    }\n    case 'SAY' : return {\n      ...state,\n      messages : state.messages.concat({\n        id : action.id,\n        from: action.from,\n        to: action.to,\n        message: action.message\n      })\n    }\n    case 'LOAD_CLIENT_STATE' : return action.state\n    default: return state\n  }\n}\n","import sharedContextReducer from './context-reducer'\nimport {combineReducers} from 'redux'\nimport {changed} from '../utils'\n\nconst initialState = {\n  connected : false,\n  shared : sharedContextReducer(undefined, {type:'@INIT@'})\n}\n\nfunction clientContextReducer(state = initialState, action){\n  switch (action.type){\n    case 'CONTEXT_SPAWNED': return {\n      shared : sharedContextReducer(state.shared, action),\n      connected: true\n    }\n    case 'CONTEXT_DESPAWNED': return {\n      shared: sharedContextReducer(state.shared, action),\n      connected: false\n    }\n    default : return changed(state, {\n      ...state,\n      shared : sharedContextReducer(state.shared, action)\n    })\n  }\n}\n\nfunction allContextsReducer(state = {}, action){\n  switch(action.type){\n    case 'CONTEXT_SPAWNED': return {...state, [action.guid]: clientContextReducer(state[action.guid], action)}\n    case 'CONTEXT_DESPAWNED': return {...state, [action.guid]: clientContextReducer(state[action.guid], action)}\n    default : return changed(state, Object.keys(state).reduce((newState, context) => {\n      newState[context] = clientContextReducer(state[context], action)\n      return newState\n    }, {}))\n  }\n}\n\nexport default combineReducers({\n  contexts : allContextsReducer\n})\n","import log from '../log'\n\nexport default {\n  onEnter: (guid, state, dispatch)=>{\n    log.info('entering state INTRODUCTION')\n  },\n  onLeave: (guid, state, dispatch)=>{\n    log.info('leaving state INTRODUCTION')\n  },\n  onCommand:(guid, state, dispatch, command)=>{\n    log.info(`in state INTRODUCTION guid:${guid} command:${command}`)\n  }\n}","import * as actionStateHandlers from './../states'\n\nexport default function serverMiddleware({ getState, dispatch }) {\n  return (next) => (action) => {\n    if(action.type === 'CONTEXT_SPAWNED'){\n      if(getState().contexts[action.guid].shared.actionState.length === 0){\n        dispatch({\n          type: 'CLIENT_STATE_ENTER_PUSH',\n          guid: action.guid,\n          name: 'introduction'\n        })\n      }\n    } else if(action.type === 'CLIENT_STATE_ENTER_PUSH' || action.type === 'CLIENT_STATE_ENTER_REPLACE') {\n      const prevActionState = getState().contexts[action.guid].shared.actionState\n      if (prevActionState.length > 0) {\n        const name = prevActionState[prevActionState.length - 1]\n        actionStateHandlers[name].onLeave(action.guid, getState(), dispatch)\n      }\n      const result = next(action)\n      const currActionState = getState().contexts[action.guid].shared.actionState\n      if (currActionState.length > 0) {\n        const name = currActionState[currActionState.length - 1]\n        actionStateHandlers[name].onEnter(action.guid, getState(), dispatch)\n      }\n      return result\n    } else if(action.type === 'COMMAND_REQUEST'){\n      const currActionState = getState().contexts[action.guid].shared.actionState\n      if (currActionState.length > 0) {\n        const name = currActionState[currActionState.length - 1]\n        actionStateHandlers[name].onCommand(action.guid, getState(), dispatch, action.command)\n      }\n    } else {\n      return next(action)\n    }\n  }\n}","import {shallowEqual} from '../../utils'\nimport log from '../log'\n\nexport default function serverMiddleware(clientGuidToSocket, { getState, dispatch }) {\n  return (next) => (action) => {\n    log.info(`Action ${JSON.stringify(action)}`)\n    const stateBeforeRequest = getState()\n    const result = next(action)\n    const stateAfterRequest = getState()\n    Object.keys(stateBeforeRequest.contexts).forEach((key) => {\n\n      const stateChanged = !shallowEqual(stateBeforeRequest.contexts[key].shared, stateAfterRequest.contexts[key].shared)\n      const targetSocket = clientGuidToSocket[key]\n      if(stateChanged){\n        log.info(`After ${action.type} state for ${key} changed, sending action`)\n        targetSocket.emit('action', action)\n      } else {\n        log.info(`After ${action.type} state for ${key} is same`)\n      }\n    })\n    return result\n  }\n}","import fs from 'fs'\nimport path from 'path'\nimport globalReducer from 'model/global-reducer'\nimport serverMiddleware from './middleware/server-middleware'\nimport responseMiddleware from './middleware/response-middleware'\nimport log from './log'\nimport {createStore, applyMiddleware} from 'redux'\n\nconst dataDirPath = path.join(__dirname, 'data')\nconst stateFilePath = path.join(__dirname, 'data/state.json')\n\nconst clientSocketIdToGuid = {}\nconst clientGuidToSocket = {}\n\nif (!fs.existsSync(dataDirPath)){\n  fs.mkdirSync(dataDirPath)\n}\nlet stateStr = '{}'\ntry {\n  stateStr = fs.readFileSync(stateFilePath, 'utf8')\n} catch(e) {\n  fs.writeFileSync(stateFilePath, '{}', { flag: 'wx' })\n}\n\nif(stateStr.trim().length === 0) stateStr = '{}'\nconst store = createStore(globalReducer, JSON.parse(stateStr), applyMiddleware(serverMiddleware,responseMiddleware.bind(undefined,clientGuidToSocket)))\n\nstore.subscribe(function persistState(){\n  const currentState = store.getState()\n  fs.writeFile(stateFilePath, JSON.stringify(currentState, null, 2), function(err) {\n    if(err) {\n      return log.error(err)\n    }\n  })\n})\n\nexport default function onSocket(io, socket){\n  const ipAddress = socket.request.connection.remoteAddress\n  const clientId = `${ipAddress}`\n  log.info(`client ??@${clientId} connected`)\n\n  socket.on('authentication', function(authToken){\n    clientSocketIdToGuid[socket.id] = authToken\n    clientGuidToSocket[authToken] = socket\n    log.info(`client ??@${clientId} authenticated as ${authToken}`)\n    store.dispatch({\n      type: 'CONTEXT_SPAWNED',\n      guid: authToken\n    })\n    socket.emit('initial_state', store.getState().contexts[authToken].shared)\n  })\n\n  socket.on('disconnect', function() {\n    log.info(`client ${clientSocketIdToGuid[socket.id]}@${clientId} disconnected`)\n    store.dispatch({\n      type: 'CONTEXT_DESPAWNED',\n      guid: clientSocketIdToGuid[socket.id]\n    })\n    clientGuidToSocket[clientSocketIdToGuid[socket.id]] = undefined\n    clientSocketIdToGuid[socket.id] = undefined\n  })\n\n  socket.on('command_request', function(action){\n    if(action.type !== 'COMMAND_REQUEST') return\n    log.info(`client ${clientSocketIdToGuid[socket.id]}@${clientId} command:${JSON.stringify(action.command)}`)\n    store.dispatch({\n      type: action.type,\n      guid: clientSocketIdToGuid[socket.id],\n      command: action.command\n    })\n  })\n}\n","import express from 'express'\nimport path from 'path'\nimport http from 'http'\nimport socketIO from 'socket.io'\n\nimport log from './log'\nimport serverIO from './server-io'\n\nconst app = express()\nconst host = '0.0.0.0'\nconst port = process.env.PORT || 8080\n\nprocess.env.PWD = process.cwd()\n\napp.use('/public', express.static(path.join(process.env.PWD, 'public')))\n\napp.get('/favicon.ico', function(req, res) {\n  res.sendFile(path.join(process.env.PWD, 'public/favicon.ico'))\n})\n\napp.get('/', function(req, res) {\n  res.sendFile(path.join(process.env.PWD, 'public/index.html'))\n})\n\nconst server = http.createServer(app)\nconst io = socketIO(server)\n\nio.on('connection', serverIO.bind(undefined, io))\n\nserver.listen(port, host, function(err) {\n  if (err) log.error(err)\n  else {\n    log.info(`Listening at http://${host}:${port}`)\n  }\n})\n"],"names":["winston","require","path","logger","Logger","transports","Console","File","filename","join","__dirname","args","debug","info","warn","error","s4","Math","floor","random","toString","substring","guid","shallowEqual","oldState","newState","resultOldToNew","Object","keys","reduce","result","oldKey","resultNewToOld","newKey","changed","initialState","contextReducer","state","action","type","actionState","concat","name","slice","length","messages","id","from","to","message","sharedContextReducer","undefined","clientContextReducer","shared","allContextsReducer","context","combineReducers","dispatch","command","serverMiddleware","getState","next","contexts","prevActionState","onLeave","currActionState","onEnter","onCommand","clientGuidToSocket","JSON","stringify","stateBeforeRequest","stateAfterRequest","forEach","key","stateChanged","targetSocket","emit","dataDirPath","stateFilePath","clientSocketIdToGuid","fs","existsSync","mkdirSync","stateStr","readFileSync","e","writeFileSync","flag","trim","store","createStore","globalReducer","parse","applyMiddleware","responseMiddleware","bind","subscribe","persistState","currentState","writeFile","err","log","onSocket","io","socket","ipAddress","request","connection","remoteAddress","clientId","on","authToken","app","express","host","port","process","env","PORT","PWD","cwd","use","static","get","req","res","sendFile","server","http","createServer","socketIO","serverIO","listen"],"mappings":";;;;;;;;;AAAA,MAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,MAAMC,SAAOD,QAAQ,MAAR,CAAb;;AAEA,MAAME,SAAS,IAAKH,QAAQI,MAAb,CAAqB;cACtB,CACV,IAAKJ,QAAQK,UAAR,CAAmBC,OAAxB,EADU,EAEV,IAAKN,QAAQK,UAAR,CAAmBE,IAAxB,CAA8B,EAAEC,UAAUN,OAAKO,IAAL,CAAUC,SAAV,EAAqB,iBAArB,CAAZ,EAA9B,CAFU;CADC,CAAf;;AAOA,UAAe;QACP,GAAGC,IAAT,EAAc;WACLC,KAAP,CAAa,GAAGD,IAAhB;GAFW;OAIR,GAAGA,IAAR,EAAa;WACJE,IAAP,CAAY,GAAGF,IAAf;GALW;OAOR,GAAGA,IAAR,EAAa;WACJG,IAAP,CAAY,GAAGH,IAAf;GARW;QAUP,GAAGA,IAAT,EAAc;WACLI,KAAP,CAAa,GAAGJ,IAAhB;;CAXJ;;ACVA,SAASK,EAAT,GAAc;SACLC,KAAKC,KAAL,CAAW,CAAC,IAAID,KAAKE,MAAL,EAAL,IAAsB,OAAjC,EACJC,QADI,CACK,EADL,EAEJC,SAFI,CAEM,CAFN,CAAP;;;AAKF,AAAe,SAASC,IAAT,GAAgB;;SAEtBN,OAAOA,IAAP,GAAc,GAAd,GAAoBA,IAApB,GAA2B,GAA3B,GAAiCA,IAAjC,GAAwC,GAAxC,GACLA,IADK,GACE,GADF,GACQA,IADR,GACeA,IADf,GACsBA,IAD7B;;;ACRa,SAASO,YAAT,CAAsBC,QAAtB,EAAgCC,QAAhC,EAAyC;QAChDC,iBAAiBC,OAAOC,IAAP,CAAYJ,QAAZ,EAAsBK,MAAtB,CAA6B,CAACC,MAAD,EAASC,MAAT,KAAoB;WAC/DD,WAAW,IAAX,GAAkBA,MAAlB,GAA2BN,SAASO,MAAT,MAAqBN,SAASM,MAAT,CAAvD;GADqB,EAEpB,KAFoB,CAAvB;;QAIMC,iBAAiBL,OAAOC,IAAP,CAAYH,QAAZ,EAAsBI,MAAtB,CAA6B,CAACC,MAAD,EAASG,MAAT,KAAoB;WAC/DH,WAAW,IAAX,GAAkBA,MAAlB,GAA2BN,SAASS,MAAT,MAAqBR,SAASQ,MAAT,CAAvD;GADqB,EAEpB,KAFoB,CAAvB;;SAIO,CAACD,cAAD,IAAmB,CAACN,cAA3B;;;ACPa,SAASQ,OAAT,CAAiBV,QAAjB,EAA2BC,QAA3B,EAAoC;;SAE1CF,aAAaC,QAAb,EAAuBC,QAAvB,IAAmCD,QAAnC,GAA8CC,QAArD;;;ACFF,MAAMU,iBAAe;eACP,EADO;YAER,CAAC;QACLb,MADK;UAEH,aAFG;QAGL,KAHK;aAIA;GAJD;CAFb;;AAUA,AAAe,SAASc,cAAT,CAAwBC,QAAQF,cAAhC,EAA8CG,MAA9C,EAAqD;UAC3DA,OAAOC,IAAd;SACO,yBAAL;+BACKF,KAD2B;qBAEjBA,MAAMG,WAAN,CAAkBC,MAAlB,CAAyBH,OAAOI,IAAhC;;SAEV,4BAAL;+BACKL,KAD+B;qBAErBA,MAAMG,WAAN,CAAkBG,KAAlB,CAAwB,CAAxB,EAA0BN,MAAMG,WAAN,CAAkBI,MAAlB,GAAyB,CAAnD,EAAsDH,MAAtD,CAA6DH,OAAOI,IAApE;;SAEV,KAAL;+BACKL,KADQ;kBAEAA,MAAMQ,QAAN,CAAeJ,MAAf,CAAsB;cAC1BH,OAAOQ,EADmB;gBAEzBR,OAAOS,IAFkB;cAG3BT,OAAOU,EAHoB;mBAItBV,OAAOW;SAJP;;SAOR,mBAAL;aAAkCX,OAAOD,KAAd;;aACXA,KAAP;;;;AC5Bb,MAAMF,eAAe;aACP,KADO;UAEVe,eAAqBC,SAArB,EAAgC,EAACZ,MAAK,QAAN,EAAhC;CAFX;;AAKA,SAASa,oBAAT,CAA8Bf,QAAQF,YAAtC,EAAoDG,MAApD,EAA2D;UACjDA,OAAOC,IAAf;SACO,iBAAL;aAA+B;gBACpBW,eAAqBb,MAAMgB,MAA3B,EAAmCf,MAAnC,CADoB;mBAElB;OAFW;SAInB,mBAAL;aAAiC;gBACvBY,eAAqBb,MAAMgB,MAA3B,EAAmCf,MAAnC,CADuB;mBAEpB;OAFa;;aAITJ,QAAQG,KAAR,oBACZA,KADY;gBAENa,eAAqBb,MAAMgB,MAA3B,EAAmCf,MAAnC;SAFD;;;;AAOd,SAASgB,kBAAT,CAA4BjB,QAAQ,EAApC,EAAwCC,MAAxC,EAA+C;UACtCA,OAAOC,IAAd;SACO,iBAAL;+BAAmCF,KAAX,IAAkB,CAACC,OAAOhB,IAAR,GAAe8B,qBAAqBf,MAAMC,OAAOhB,IAAb,CAArB,EAAyCgB,MAAzC,CAAjC;SACnB,mBAAL;+BAAqCD,KAAX,IAAkB,CAACC,OAAOhB,IAAR,GAAe8B,qBAAqBf,MAAMC,OAAOhB,IAAb,CAArB,EAAyCgB,MAAzC,CAAjC;;aACTJ,QAAQG,KAAR,EAAeV,OAAOC,IAAP,CAAYS,KAAZ,EAAmBR,MAAnB,CAA0B,CAACJ,QAAD,EAAW8B,OAAX,KAAuB;iBACtEA,OAAT,IAAoBH,qBAAqBf,MAAMkB,OAAN,CAArB,EAAqCjB,MAArC,CAApB;eACOb,QAAP;OAF8B,EAG7B,EAH6B,CAAf,CAAP;;;;AAOd,oBAAe+B,sBAAgB;YAClBF;CADE,CAAf;;ACnCA,mBAAe;WACJ,CAAChC,IAAD,EAAOe,KAAP,EAAcoB,QAAd,KAAyB;QAC5B5C,IAAJ,CAAS,6BAAT;GAFW;WAIJ,CAACS,IAAD,EAAOe,KAAP,EAAcoB,QAAd,KAAyB;QAC5B5C,IAAJ,CAAS,4BAAT;GALW;aAOH,CAACS,IAAD,EAAOe,KAAP,EAAcoB,QAAd,EAAwBC,OAAxB,KAAkC;QACtC7C,IAAJ,CAAU,+BAA6BS,IAAK,cAAWoC,OAAQ,GAA/D;;CARJ;;;;;;;;ACAe,SAASC,gBAAT,CAA0B,EAAEC,QAAF,EAAYH,QAAZ,EAA1B,EAAkD;SACvDI,IAAD,IAAWvB,MAAD,IAAY;QACxBA,OAAOC,IAAP,KAAgB,iBAAnB,EAAqC;UAChCqB,WAAWE,QAAX,CAAoBxB,OAAOhB,IAA3B,EAAiC+B,MAAjC,CAAwCb,WAAxC,CAAoDI,MAApD,KAA+D,CAAlE,EAAoE;iBACzD;gBACD,yBADC;gBAEDN,OAAOhB,IAFN;gBAGD;SAHR;;KAFJ,MAQO,IAAGgB,OAAOC,IAAP,KAAgB,yBAAhB,IAA6CD,OAAOC,IAAP,KAAgB,4BAAhE,EAA8F;YAC7FwB,kBAAkBH,WAAWE,QAAX,CAAoBxB,OAAOhB,IAA3B,EAAiC+B,MAAjC,CAAwCb,WAAhE;UACIuB,gBAAgBnB,MAAhB,GAAyB,CAA7B,EAAgC;cACxBF,OAAOqB,gBAAgBA,gBAAgBnB,MAAhB,GAAyB,CAAzC,CAAb;4BACoBF,IAApB,EAA0BsB,OAA1B,CAAkC1B,OAAOhB,IAAzC,EAA+CsC,UAA/C,EAA2DH,QAA3D;;YAEI3B,SAAS+B,KAAKvB,MAAL,CAAf;YACM2B,kBAAkBL,WAAWE,QAAX,CAAoBxB,OAAOhB,IAA3B,EAAiC+B,MAAjC,CAAwCb,WAAhE;UACIyB,gBAAgBrB,MAAhB,GAAyB,CAA7B,EAAgC;cACxBF,OAAOuB,gBAAgBA,gBAAgBrB,MAAhB,GAAyB,CAAzC,CAAb;4BACoBF,IAApB,EAA0BwB,OAA1B,CAAkC5B,OAAOhB,IAAzC,EAA+CsC,UAA/C,EAA2DH,QAA3D;;aAEK3B,MAAP;KAZK,MAaA,IAAGQ,OAAOC,IAAP,KAAgB,iBAAnB,EAAqC;YACpC0B,kBAAkBL,WAAWE,QAAX,CAAoBxB,OAAOhB,IAA3B,EAAiC+B,MAAjC,CAAwCb,WAAhE;UACIyB,gBAAgBrB,MAAhB,GAAyB,CAA7B,EAAgC;cACxBF,OAAOuB,gBAAgBA,gBAAgBrB,MAAhB,GAAyB,CAAzC,CAAb;4BACoBF,IAApB,EAA0ByB,SAA1B,CAAoC7B,OAAOhB,IAA3C,EAAiDsC,UAAjD,EAA6DH,QAA7D,EAAuEnB,OAAOoB,OAA9E;;KAJG,MAMA;aACEG,KAAKvB,MAAL,CAAP;;GA7BJ;;;ACAa,SAASqB,kBAAT,CAA0BS,kBAA1B,EAA8C,EAAER,QAAF,EAAYH,QAAZ,EAA9C,EAAsE;SAC3EI,IAAD,IAAWvB,MAAD,IAAY;QACvBzB,IAAJ,CAAU,WAASwD,KAAKC,SAAL,CAAehC,MAAf,CAAuB,GAA1C;UACMiC,qBAAqBX,UAA3B;UACM9B,SAAS+B,KAAKvB,MAAL,CAAf;UACMkC,oBAAoBZ,UAA1B;WACOhC,IAAP,CAAY2C,mBAAmBT,QAA/B,EAAyCW,OAAzC,CAAkDC,GAAD,IAAS;;YAElDC,eAAe,CAACpD,aAAagD,mBAAmBT,QAAnB,CAA4BY,GAA5B,EAAiCrB,MAA9C,EAAsDmB,kBAAkBV,QAAlB,CAA2BY,GAA3B,EAAgCrB,MAAtF,CAAtB;YACMuB,eAAeR,mBAAmBM,GAAnB,CAArB;UACGC,YAAH,EAAgB;YACV9D,IAAJ,CAAU,UAAQyB,OAAOC,IAAK,gBAAamC,GAAI,2BAA/C;qBACaG,IAAb,CAAkB,QAAlB,EAA4BvC,MAA5B;OAFF,MAGO;YACDzB,IAAJ,CAAU,UAAQyB,OAAOC,IAAK,gBAAamC,GAAI,WAA/C;;KARJ;WAWO5C,MAAP;GAhBF;;;ACIF,MAAMgD,cAAc5E,KAAKO,IAAL,CAAUC,SAAV,EAAqB,MAArB,CAApB;AACA,MAAMqE,gBAAgB7E,KAAKO,IAAL,CAAUC,SAAV,EAAqB,iBAArB,CAAtB;;AAEA,MAAMsE,uBAAuB,EAA7B;AACA,MAAMZ,qBAAqB,EAA3B;;AAEA,IAAI,CAACa,GAAGC,UAAH,CAAcJ,WAAd,CAAL,EAAgC;KAC3BK,SAAH,CAAaL,WAAb;;AAEF,IAAIM,WAAW,IAAf;AACA,IAAI;aACSH,GAAGI,YAAH,CAAgBN,aAAhB,EAA+B,MAA/B,CAAX;CADF,CAEE,OAAMO,CAAN,EAAS;KACNC,aAAH,CAAiBR,aAAjB,EAAgC,IAAhC,EAAsC,EAAES,MAAM,IAAR,EAAtC;;;AAGF,IAAGJ,SAASK,IAAT,GAAgB7C,MAAhB,KAA2B,CAA9B,EAAiCwC,WAAW,IAAX;AACjC,MAAMM,QAAQC,kBAAYC,aAAZ,EAA2BvB,KAAKwB,KAAL,CAAWT,QAAX,CAA3B,EAAiDU,sBAAgBnC,gBAAhB,EAAiCoC,mBAAmBC,IAAnB,CAAwB7C,SAAxB,EAAkCiB,kBAAlC,CAAjC,CAAjD,CAAd;;AAEAsB,MAAMO,SAAN,CAAgB,SAASC,YAAT,GAAuB;QAC/BC,eAAeT,MAAM9B,QAAN,EAArB;KACGwC,SAAH,CAAarB,aAAb,EAA4BV,KAAKC,SAAL,CAAe6B,YAAf,EAA6B,IAA7B,EAAmC,CAAnC,CAA5B,EAAmE,UAASE,GAAT,EAAc;QAC5EA,GAAH,EAAQ;aACCC,IAAIvF,KAAJ,CAAUsF,GAAV,CAAP;;GAFJ;CAFF;;AASA,AAAe,SAASE,QAAT,CAAkBC,EAAlB,EAAsBC,MAAtB,EAA6B;QACpCC,YAAYD,OAAOE,OAAP,CAAeC,UAAf,CAA0BC,aAA5C;QACMC,WAAY,IAAEJ,SAAU,GAA9B;MACI7F,IAAJ,CAAU,cAAYiG,QAAS,aAA/B;;SAEOC,EAAP,CAAU,gBAAV,EAA4B,UAASC,SAAT,EAAmB;yBACxBP,OAAO3D,EAA5B,IAAkCkE,SAAlC;uBACmBA,SAAnB,IAAgCP,MAAhC;QACI5F,IAAJ,CAAU,cAAYiG,QAAS,uBAAoBE,SAAU,GAA7D;UACMvD,QAAN,CAAe;YACP,iBADO;YAEPuD;KAFR;WAIOnC,IAAP,CAAY,eAAZ,EAA6Ba,MAAM9B,QAAN,GAAiBE,QAAjB,CAA0BkD,SAA1B,EAAqC3D,MAAlE;GARF;;SAWO0D,EAAP,CAAU,YAAV,EAAwB,YAAW;QAC7BlG,IAAJ,CAAU,WAASmE,qBAAqByB,OAAO3D,EAA5B,CAAgC,MAAGgE,QAAS,gBAA/D;UACMrD,QAAN,CAAe;YACP,mBADO;YAEPuB,qBAAqByB,OAAO3D,EAA5B;KAFR;uBAImBkC,qBAAqByB,OAAO3D,EAA5B,CAAnB,IAAsDK,SAAtD;yBACqBsD,OAAO3D,EAA5B,IAAkCK,SAAlC;GAPF;;SAUO4D,EAAP,CAAU,iBAAV,EAA6B,UAASzE,MAAT,EAAgB;QACxCA,OAAOC,IAAP,KAAgB,iBAAnB,EAAsC;QAClC1B,IAAJ,CAAU,WAASmE,qBAAqByB,OAAO3D,EAA5B,CAAgC,MAAGgE,QAAS,cAAWzC,KAAKC,SAAL,CAAehC,OAAOoB,OAAtB,CAA+B,GAAzG;UACMD,QAAN,CAAe;YACPnB,OAAOC,IADA;YAEPyC,qBAAqByB,OAAO3D,EAA5B,CAFO;eAGJR,OAAOoB;KAHlB;GAHF;;;ACtDF,MAAMuD,MAAMC,SAAZ;AACA,MAAMC,OAAO,SAAb;AACA,MAAMC,OAAOC,QAAQC,GAAR,CAAYC,IAAZ,IAAoB,IAAjC;;AAEAF,QAAQC,GAAR,CAAYE,GAAZ,GAAkBH,QAAQI,GAAR,EAAlB;;AAEAR,IAAIS,GAAJ,CAAQ,SAAR,EAAmBR,QAAQS,MAAR,CAAezH,KAAKO,IAAL,CAAU4G,QAAQC,GAAR,CAAYE,GAAtB,EAA2B,QAA3B,CAAf,CAAnB;;AAEAP,IAAIW,GAAJ,CAAQ,cAAR,EAAwB,UAASC,GAAT,EAAcC,GAAd,EAAmB;MACrCC,QAAJ,CAAa7H,KAAKO,IAAL,CAAU4G,QAAQC,GAAR,CAAYE,GAAtB,EAA2B,oBAA3B,CAAb;CADF;;AAIAP,IAAIW,GAAJ,CAAQ,GAAR,EAAa,UAASC,GAAT,EAAcC,GAAd,EAAmB;MAC1BC,QAAJ,CAAa7H,KAAKO,IAAL,CAAU4G,QAAQC,GAAR,CAAYE,GAAtB,EAA2B,mBAA3B,CAAb;CADF;;AAIA,MAAMQ,SAASC,KAAKC,YAAL,CAAkBjB,GAAlB,CAAf;AACA,MAAMT,KAAK2B,SAASH,MAAT,CAAX;;AAEAxB,GAAGO,EAAH,CAAM,YAAN,EAAoBqB,SAASpC,IAAT,CAAc7C,SAAd,EAAyBqD,EAAzB,CAApB;;AAEAwB,OAAOK,MAAP,CAAcjB,IAAd,EAAoBD,IAApB,EAA0B,UAASd,GAAT,EAAc;MAClCA,GAAJ,EAASC,IAAIvF,KAAJ,CAAUsF,GAAV,EAAT,KACK;QACCxF,IAAJ,CAAU,wBAAsBsG,IAAK,MAAGC,IAAK,GAA7C;;CAHJ"}